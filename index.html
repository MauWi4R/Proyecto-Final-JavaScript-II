<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proyecto JavaScript II</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">


    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="main-header">
      <div class="container">
        <h1>Buscar vuelo</h1>
        <nav>
          <ul>
              <li><a href="#">Inicio</a></li>
              <li><a href="#">Acerca de nosotros</a></li>
              <li><a href="#">Contacto</a></li>
          </ul>
      </nav>
      </div>
    </header>
    <!--Formulario Obligatorio-->
    <div class="form-container">
        <div class="container">
            <form id="searchForm">
                <input type="text" id="from" name="from" placeholder="Origen" required>
                <input type="text" id="to" name="to" placeholder="Destino" required>
                <input type="date" id="dateRange" name="dateRange" placeholder="Seleccionar fecha de viaje" required>
                <input type="number" id="passengers" name="passengers" placeholder="Número de Pasajeros" required>
                <button type="button" id="searchButton">Buscar</button>
            </form>
        </div>
    </div>

    <!--Filtros-->
    <div class="container">
      <div class="row">
        <div class="col">
          <strong>Aerolínea</strong>
          <select id="aerolinea">
            <option value="Germany">Germany AirLine</option>
            <option value="Sky">Sky Airways</option>
            <option value="Oceanic">Oceanic Airways</option>
          </select>
          </div>

        <div class="col">
          <strong>Escalas</strong>
          <select id="tipoVuelo">
            <option value="all">Todas las opciones</option>
            <option value="directo">Vuelos Directos</option>
            <option value="escala">Escalas</option>
          </select>
        </div>

        <div class="col">
          <strong>Hora de Salida</strong>
          <select id="horaSalida">
            <option value="">Todas las opciones</option>
            <option value="manana">Por la Mañana</option>
            <option value="tarde">Por la Tarde</option>
          </select>
        </div>

        <div class="col">
          <strong>Hora de Llegada</strong>
          <select id="horaLlegada">
            <option value="">Todas las opciones</option>
            <option value="mananas">Por la Mañana</option>
            <option value="tardes">Por la Tarde</option>
            <option value="noches">Por la Noche</option>
          </select>
        </div>

        <div class="col">
          <strong>Precios</strong>
          <select id="precio">
            <option value="mas">Mayor Precio</option>
            <option value="menos">Menor Precio</option>
          </select>
        </div>

      </div>
    </div>


    <!--Carta Vuelo-->
    <h2 id="opcionesDisponibles" style="display: none;">Opciones Disponibles</h2>

    <div class="row" id="resultados">
      
    </div>

    <footer>
            <div class="col">
                <p>&copy; 2024 Compañía de vuelos. Todos los derechos reservados.</p>
            </div>
    </footer>


  <script>

  function listar_vuelos(data){
    
    var cardElement = document.createElement('div');
    cardElement.className = 'col-3';
    //cardElement.style.width = '18rem';
    cardElement.innerHTML = `
    <div class='card'>
        <div class='card-body'>
            <h5 class='card-title'>Vuelo: ${data.numero_vuelo}</h5>
              <h6 class='card-subtitle mb-2 text-muted'>${createDepartureInfo(data).outerHTML}</h6>
              <h6 class='card-subtitle mb-2 text-muted'>A las ${data.horaSalida}</h6>
            <p class='card-text'>Desde ${data.aeropuerto_salida}<br>
              <h6 class='card-subtitle mb-2 text-muted'>${createArrivalInfo(data).outerHTML}</h6>
              <h6 class='card-subtitle mb-2 text-muted'>A las ${data.horaLlegada}</h6>
            <p class='card-text'>a ${data.aeropuerto_llegada}<br>
            Escalas: ${data.num_escalas}<br>
            Precio: $${data.precio}<br>
            Aerolínea: ${data.aerolinea}<br>
            <button class="btn btn-primary">Seleccionar</button>
          </p>
        </div>
      </div>
    `;

    
    
    
    // Agrega la tarjeta al contenedor deseado en el DOM
    document.getElementById('resultados').appendChild(cardElement);
  }

    // Espera a que el DOM esté completamente cargado
document.addEventListener("DOMContentLoaded", function() {
    // Obtén el botón por su ID
    var searchButton = document.getElementById("searchButton");

    ///////
    var tipoVueloSelect = document.getElementById("tipoVuelo");
    var data;
    ///////
    var horaSalidaSelect = document.getElementById("horaSalida");
    ///////
    var horaLlegadaSelect = document.getElementById("horaLlegada");
    ///////
    var precioSelect = document.getElementById("precio");

    var passengers = parseInt(document.getElementById('passengers').value);

        // Validar si el número de pasajeros está dentro del rango permitido
        if (passengers < 1 || passengers > 30) {
            return;
        }

    // Agrega un listener para el evento 'click'
    searchButton.addEventListener("click", function() {
        // Coloca aquí el código que deseas ejecutar cuando se haga clic en el botón
        console.log("Se ha hecho clic en el botón de búsqueda.");

    ////
    var tipoVueloSeleccionado = tipoVueloSelect.value;
    var horaSalidaSeleccionada = horaSalidaSelect.value;
    var horaLlegadaSeleccionada = horaLlegadaSelect.value;
    var precioSeleccionado = precioSelect.value;
    ////

        aerolinea = document.getElementById("aerolinea").value;
        from = document.getElementById("from").value;
        to = document.getElementById("to").value;
        date = document.getElementById("dateRange").value;

        url ='http://localhost:3000/';
        if (aerolinea !== "all") { // Si no es la opción comodín, añade la aerolínea a la URL
          url += aerolinea;
        }

      axios.get(url, {
    params: {
      aeropuerto_salida: from,
      aeropuerto_llegada: to,
      fecha_salida: date
        }
      })
      .then(function (response) {
       //console.log(response.data);

      ///////
      if (response && response.data) {
                data = response.data;
                console.log("Datos de la respuesta de la solicitud AJAX:", data);
            } else {
                console.error("La respuesta de la solicitud AJAX no contiene datos válidos.");
            }
      //////

      if (precioSeleccionado === "mas") {
                data.sort(function(a, b) {
                    return b.precio - a.precio; // Ordenar de mayor a menor precio
                });
            } else if (precioSeleccionado === "menos") {
                data.sort(function(a, b) {
                    return a.precio - b.precio; // Ordenar de menor a mayor precio
                });
            }

      /////

       document.getElementById('resultados').innerHTML = "";
        
       //response.
        //data.forEach(function(item) {
          
          /////
          if (horaSalidaSeleccionada === "manana") {
    // Filtrar vuelos con hora de salida por la mañana
    data = data.filter(function(vuelo) {
      var horaSalida = parseInt(vuelo.horaSalida.split(":")[0]);
        return horaSalida < 12;
    });
} else if (horaSalidaSeleccionada === "tarde") {
    // Filtrar vuelos con hora de salida por la tarde
    data = data.filter(function(vuelo) {
      var horaSalida = parseInt(vuelo.horaSalida.split(":")[0]);
        return horaSalida >= 12
    });
}
/////

if (horaLlegadaSeleccionada === "mananas") {
                data = data.filter(function(vuelo) {
                    var horaLlegada = parseInt(vuelo.horaLlegada.split(":")[0]);
                    return horaLlegada < 12;
                });
            } else if (horaLlegadaSeleccionada === "tardes") {
                data = data.filter(function(vuelo) {
                    var horaLlegada = parseInt(vuelo.horaLlegada.split(":")[0]);
                    return horaLlegada >= 12 && horaLlegada < 20;
                });
            } else if (horaLlegadaSeleccionada === "noches") {
                data = data.filter(function(vuelo) {
                    var horaLlegada = parseInt(vuelo.horaLlegada.split(":")[0]);
                    return horaLlegada >= 20;
                });
            }

          ///////
          if (data) { // Comprueba si data está definida antes de utilizarla
                data.forEach(function(item) {
              
                    if ((tipoVueloSeleccionado === "directo" && item.num_escalas === 0) ||
                        (tipoVueloSeleccionado === "escala" && item.num_escalas !== 0) ||
                        (tipoVueloSeleccionado === "all")){
          //  console.log(item);
            listar_vuelos(item);
            }
            //////listar vuelos ya estaba
        });
      }
      
      if (data && data.length > 0) {
            data.forEach(function(item) {
                // Resto del código...
            });
            document.getElementById('opcionesDisponibles').style.display = 'block';
        } else {
            // No hay resultados disponibles, mostrar mensaje
            var noOptionsMessage = document.createElement('h2');
            noOptionsMessage.textContent = "Lo sentimos, no hay opciones disponibles :(";
            document.getElementById('resultados').appendChild(noOptionsMessage);
            document.getElementById('opcionesDisponibles').style.display = 'none';
        }

      })
      .catch(function (error) {
        console.log("Error en la solicitud AJAX:", error);
      })
      .finally(function () {
        // siempre sera ejecutado
      });  
      
     });
});

//FECHA
function createParagraph(text, className) {
    const paragraph = document.createElement('p');
    paragraph.className = className;
    paragraph.textContent = text;
    return paragraph;
}

function transformarFecha(fecha) {
    const partes = fecha.split("-");
    
    // Formato (dd-mm-yyyy)
    const fechaTransformada = `${partes[2]}-${partes[1]}-${partes[0]}`;
    
    return fechaTransformada;
}

function createDepartureInfo(vuelo) {
    const fechaSalidaTransformada = transformarFecha(vuelo.fecha_salida);
    const info = `Salida: ${fechaSalidaTransformada}`;
    return createParagraph(info, 'card-text');
}

function createArrivalInfo(vuelo) {
    const fechaLlegadaTransformada = transformarFecha(vuelo.fecha_llegada);
    const info = `Destino: ${fechaLlegadaTransformada}`;
    return createParagraph(info, 'card-text');
}

</script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

</body>
</html>